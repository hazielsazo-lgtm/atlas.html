<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>ATLAS - Albion Online (con Firestore)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&display=swap');

    :root {
      --gold-1:#d4af37; --gold-2:#c29b2d;
      --bg-dark:#0f0f10; --bg-light:#f3efe1;
      --panel-dark:rgba(0,0,0,0.72); --panel-light:rgba(255,255,245,0.92);
      --accent-ho:#0b66ff; --accent-hq:#23a34a; --danger:#e53935;
      --text-light:#f7f2ea; --text-dark:#111;
      --muted: rgba(255,255,255,0.65);
    }

    html,body{height:100%;margin:0;padding:0;font-family:"Cinzel",serif}
    body{
      background: linear-gradient(180deg,var(--bg-dark),#070707);
      color:var(--text-light);
      min-height:100vh;
      padding:28px;
      display:flex;
      justify-content:center;
      box-sizing:border-box;
      transition:background .25s,color .25s;
    }
    body.light{
      background: var(--bg-light);
      color:var(--text-dark);
    }

    .container{
      width:100%;
      max-width:980px;
      background:var(--panel-dark);
      border-radius:12px;
      padding:22px;
      box-shadow:0 10px 30px rgba(0,0,0,0.6);
      backdrop-filter:blur(4px);
      transition:background .25s, color .25s;
    }
    body.light .container{ background:var(--panel-light); box-shadow:0 8px 18px rgba(0,0,0,0.08); }

    .header-row{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px; }
    h1{ margin:0; font-size:28px; letter-spacing:1px; background:linear-gradient(90deg,var(--gold-1),var(--gold-2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }

    /* small switch (palanca) */
    .theme-switch{ display:flex; align-items:center; gap:8px; font-size:13px; user-select:none; }
    .switch{ width:46px; height:24px; background:rgba(255,255,255,0.12); border-radius:999px; position:relative; cursor:pointer; }
    body.light .switch{ background:rgba(0,0,0,0.06); }
    .knob{ position:absolute; top:2px; left:2px; width:20px; height:20px; border-radius:50%; background:linear-gradient(180deg,#fff,#ddd); box-shadow:0 2px 6px rgba(0,0,0,0.25); transition:left .18s; }
    .switch.on .knob{ left:24px; }

    .controls-row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:14px; }
    .search-input{ flex:1 1 420px; }

    input[type="text"], select {
      width:100%; padding:10px 12px; border-radius:6px; border:1px solid rgba(0,0,0,0.12);
      background: rgba(255,255,255,0.02); color:inherit; box-sizing:border-box; font-size:14px;
    }
    body.light input[type="text"], body.light select { background: rgba(0,0,0,0.02); color:var(--text-dark); }

    .btn{ padding:10px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:700; }
    .btn.small{ padding:7px 10px; font-size:13px; }
    .btn.save{ background:linear-gradient(90deg,var(--gold-1),var(--gold-2)); color:#111; }
    .btn.load{ background:#8b6f2a; color:white; }
    .btn.add{ background:#2d6a2b; color:white; }
    .btn.gray{ background:#6b6b6b; color:white; }

    table{ width:100%; border-collapse:collapse; margin-top:8px; font-size:14px; }
    th, td{ padding:12px 10px; border-bottom:1px solid rgba(255,255,255,0.04); text-align:left; vertical-align:top; }
    body.light th, body.light td{ border-color: rgba(0,0,0,0.06); }
    th{ color:var(--gold-1); font-weight:700; background: rgba(0,0,0,0.06); }

    td.map-name{ font-weight:700; width:28%; text-transform: none; }
    td.guilds{ width:50%; }

    /* gremios: vi√±eta dorada y lista vertical */
    .guild-row{ margin-bottom:8px; display:flex; align-items:center; gap:10px; }
    .bullet{ width:10px; height:10px; border-radius:50%; background:var(--gold-1); flex:0 0 10px; margin-left:-2px; margin-top:3px; }
    .guild-text{ display:flex; align-items:center; gap:8px; font-weight:600; text-transform:uppercase; font-size:13px; }
    .tag{ padding:3px 8px; border-radius:999px; font-size:12px; font-weight:800; color:#fff; }
    .tag.ho{ background:var(--accent-ho); } .tag.hq{ background:var(--accent-hq); }

    .action-cell{ display:flex; flex-direction:column; gap:8px; align-items:flex-start; }
    .action-cell button{ width:120px; padding:8px 10px; border-radius:8px; font-weight:700; cursor:pointer; }
    .action-edit{ background: linear-gradient(90deg,#ff9800,#ffb366); border:none; color:#111; }
    .action-del{ background: linear-gradient(90deg,#e53935,#b71c1c); border:none; color:#fff; }

    .history{ font-size:12px; color:var(--muted); }
    body.light .history{ color: rgba(0,0,0,0.6); }

    /* Form area */
    .form{ margin-top:16px; padding-top:12px; border-top:1px dashed rgba(255,255,255,0.04); }
    .form h3{ margin:0 0 8px 0; color:var(--gold-1); }
    .form .top-row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:10px; }
    .form input[type="text"]{ flex:1 1 360px; padding:10px; }
    .row-guild{ display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    .row-guild input[type="text"]{ flex:1; padding:8px; }
    .row-guild select{ width:140px; padding:8px; }
    .remove-guild{ background:transparent; color:var(--danger); border:none; cursor:pointer; font-weight:700; padding:6px 8px; }

    .add-guild-btn{ background:rgba(255,255,255,0.03); padding:8px 10px; border-radius:6px; cursor:pointer; color:inherit; border:1px solid rgba(0,0,0,0.06); }

    .user-info { font-size: 12px; margin-top: 4px; color: var(--muted); }
    .user-info strong { color: var(--gold-1); }

    @media (max-width:760px){ .action-cell button{ width:100%; } .header-row{ flex-direction:column; align-items:flex-start; gap:10px; } }
  </style>
</head>
<body>
  <div class="container" role="application" aria-label="ATLAS - Albion Online (con Firestore)">
    <div class="header-row">
      <h1>ATLAS - Albion Online (con Firestore)</h1>
      <div style="display:flex; align-items:center; gap:12px;">
        <div class="theme-switch" title="Alternar tema">
          <div style="font-size:12px; font-weight:700; opacity:.9">Tema</div>
          <div id="themeSwitch" class="switch" role="button" tabindex="0"><div class="knob"></div></div>
        </div>

        <div style="display:flex; gap:8px; align-items:center;">
          <button id="saveBtn" class="btn save small" title="Guardar en Firestore (sincronizaci√≥n autom√°tica)">üíæ Firestore</button>
          <button id="loadBtn" class="btn load small" title="Exportar a JSON">üìÇ Exportar</button>
          <input id="fileInput" type="file" accept=".json,application/json" style="display:none">
        </div>
      </div>
    </div>
    <div id="userInfoDisplay" class="user-info">Cargando usuario...</div>
    <div class="controls-row">
      <input id="searchInput" class="search-input" type="text" placeholder="Buscar mapa o gremio...">
    </div>

    <table aria-live="polite" id="mainTable">
      <thead><tr><th>Mapa</th><th>Gremios</th><th>Acci√≥n</th></tr></thead>
      <tbody id="resultTableBody"></tbody>
    </table>

    <div class="form" id="editor">
      <h3>Agregar / Editar</h3>

      <div class="top-row">
        <input id="mapInput" type="text" placeholder="Nombre del mapa (ej. Sunfang Cliffs)">
        <button id="addGuildRow" class="add-guild-btn">+ Agregar gremio</button>
      </div>

      <div id="guildListContainer" aria-label="Lista de gremios para el formulario" style="margin-bottom:6px"></div>

      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button id="applyBtn" class="btn add">Agregar / Guardar</button>
        <button id="importLocalBtn" class="btn gray small">Importar JSON Local</button>
        <button id="clearForm" class="btn small">Limpiar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, writeBatch, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Configuraci√≥n e Inicializaci√≥n de Firebase ---
    setLogLevel('Debug');
    
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    if (!firebaseConfig || !firebaseConfig.apiKey) {
      console.error("Firebase config is missing or invalid. Check __firebase_config.");
    }

    let app, db, auth;
    let userId = null;
    let isAuthReady = false;

    try {
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
    } catch (e) {
      console.error("Error initializing Firebase:", e);
    }

    // Colecci√≥n p√∫blica para compartir la data
    const MAPS_COLLECTION = 'maps';

    function getCollectionPath() {
      if (!userId) return null;
      // Usamos una ruta p√∫blica para que todos los usuarios vean los mismos datos
      return `artifacts/${appId}/public/data/${MAPS_COLLECTION}`;
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        userId = user.uid;
      } else {
        // Intenta iniciar sesi√≥n an√≥nimamente si no hay token o si fall√≥
        try {
          if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
            userId = auth.currentUser.uid;
          } else {
            const anonUser = await signInAnonymously(auth);
            userId = anonUser.user.uid;
          }
        } catch (error) {
          console.error("Error signing in to Firebase:", error);
          // Fallback user ID for non-authenticated operations (will fail security rules if enforced)
          userId = crypto.randomUUID(); 
        }
      }

      isAuthReady = true;
      document.getElementById('userInfoDisplay').innerHTML = `Usuario ID: <strong>${userId}</strong>`;
      setupRealtimeListener();
    });

    // --- estado y referencias ---
    let data = []; // Ahora la data se carga de Firestore
    let editingMap = null; // si editando, contiene el mapId original (que es el nombre del mapa)
    const resultTableBody = document.getElementById('resultTableBody');
    const searchInput = document.getElementById('searchInput');
    const saveBtn = document.getElementById('saveBtn'); // Ahora es el bot√≥n de sincronizaci√≥n de Firestore (renombrado en HTML)
    const exportBtn = document.getElementById('loadBtn'); // Ahora es el bot√≥n de Exportar (renombrado en HTML)
    const importLocalBtn = document.getElementById('importLocalBtn'); // Nuevo bot√≥n de importaci√≥n
    const fileInput = document.getElementById('fileInput');
    const themeSwitch = document.getElementById('themeSwitch');
    const bodyEl = document.body;

    const mapInput = document.getElementById('mapInput');
    const guildListContainer = document.getElementById('guildListContainer');
    const addGuildRowBtn = document.getElementById('addGuildRow');
    const applyBtn = document.getElementById('applyBtn');
    const clearFormBtn = document.getElementById('clearForm');

    // --- Helpers CRUD Firestore ---
    async function saveDataToFirestore(mapItem) {
      if (!isAuthReady || !userId) return Swal.fire('Error', 'Autenticaci√≥n no lista.', 'error');
      
      const docRef = doc(db, getCollectionPath(), mapItem.map);
      const now = new Date().toLocaleString();
      
      try {
        await setDoc(docRef, {
          map: mapItem.map,
          guilds: mapItem.guilds,
          lastEdited: now,
          editorId: userId // Registrar qui√©n lo edit√≥
        }, { merge: false }); // Usamos setDoc sin merge para guardar el objeto completo

        console.log("Document successfully written/updated!");
        return true;
      } catch (e) {
        console.error("Error adding/updating document: ", e);
        Swal.fire('Error de Guardado', 'No se pudo guardar en Firestore.', 'error');
        return false;
      }
    }

    async function deleteDataFromFirestore(mapName) {
      if (!isAuthReady || !userId) return Swal.fire('Error', 'Autenticaci√≥n no lista.', 'error');
      
      const docRef = doc(db, getCollectionPath(), mapName);
      
      try {
        await deleteDoc(docRef);
        console.log("Document successfully deleted!");
        return true;
      } catch (e) {
        console.error("Error deleting document: ", e);
        Swal.fire('Error de Eliminaci√≥n', 'No se pudo eliminar de Firestore.', 'error');
        return false;
      }
    }

    function setupRealtimeListener() {
      if (!isAuthReady || !userId || !db) return;

      const mapsRef = collection(db, getCollectionPath());
      const q = query(mapsRef);

      // onSnapshot escucha los cambios en tiempo real
      onSnapshot(q, (snapshot) => {
        data = [];
        snapshot.forEach((doc) => {
          const item = doc.data();
          // doc.id es el map name, lo cual es redundante pero √∫til para Firestore.
          data.push(item);
        });
        
        // Normalizar y renderizar despu√©s de cargar/actualizar
        normalizeData();
        renderResults(searchInput.value);
        
        console.log("Firestore data updated. Total maps:", data.length);
      }, (error) => {
        console.error("Error in onSnapshot listener:", error);
        Swal.fire('Error de Sincronizaci√≥n', 'No se pudo conectar a Firestore para obtener actualizaciones en tiempo real.', 'error');
      });
    }
    
    // --- Resto de las funciones (L√≥gica de UI) ---
    
    // --- helpers para filas de gremio en form ---
    function createGuildFormRow(name = '', type = 'HO') {
      const wrapper = document.createElement('div');
      wrapper.className = 'row-guild';

      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'Nombre del gremio';
      input.value = name;

      const select = document.createElement('select');
      const o1 = new Option('HO (Hideout)', 'HO');
      const o2 = new Option('HQ (Headquarters)', 'HQ');
      select.add(o1); select.add(o2);
      select.value = type;

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'remove-guild';
      removeBtn.title = 'Eliminar este gremio';
      removeBtn.textContent = 'X';
      removeBtn.onclick = () => wrapper.remove();

      wrapper.appendChild(input);
      wrapper.appendChild(select);
      wrapper.appendChild(removeBtn);
      return wrapper;
    }

    function clearGuildForm() {
      guildListContainer.innerHTML = '';
      guildListContainer.appendChild(createGuildFormRow('', 'HO'));
    }

    addGuildRowBtn.addEventListener('click', (e) => { e.preventDefault(); guildListContainer.appendChild(createGuildFormRow('', 'HO')); });
    clearFormBtn.addEventListener('click', () => { editingMap = null; mapInput.value = ''; clearGuildForm(); });

    // --- normalizar datos: convertir guild string -> {name,type} (se mantiene para compatibilidad y limpieza) ---
    function normalizeData() {
      data = (data || []).map(item => {
        if (!item || typeof item !== 'object') return null;
        const mapName = item.map || item.mapa || item.name || '';
        let guilds = item.guilds || item.gremios || [];
        if (!Array.isArray(guilds)) guilds = [];
        guilds = guilds.map(g => {
          if (typeof g === 'string') return { name: g, type: 'HO' };
          if (typeof g === 'object' && g !== null) {
            return {
              name: g.name || g.nombre || '',
              type: (g.type === 'HQ' || g.type === 'HO') ? g.type : (g.tipo === 'HQ' || g.tipo === 'HO' ? g.tipo : 'HO')
            };
          }
          return null;
        }).filter(Boolean);
        const lastEdited = item.lastEdited || item.ultimaEdicion || item.last_edit || null;
        const editorId = item.editorId || null;
        return { map: mapName, guilds, lastEdited, editorId };
      }).filter(Boolean);
      
      // Ordenar por nombre de mapa
      data.sort((a, b) => a.map.localeCompare(b.map));
    }

    // --- renderizar tabla ---
    function renderResults(filter = '') {
      const q = (filter || '').trim().toLowerCase();
      resultTableBody.innerHTML = '';
      if (!Array.isArray(data) || data.length === 0) {
        resultTableBody.innerHTML = '<tr><td colspan="3">‚öîÔ∏è No hay mapas cargados</td></tr>';
        return;
      }

      const filtered = data.filter(item => {
        if (!q) return true;
        if ((item.map || '').toLowerCase().includes(q)) return true;
        if (item.guilds.some(g => (g.name || '').toLowerCase().includes(q))) return true;
        return false;
      });

      if (filtered.length === 0) {
        resultTableBody.innerHTML = '<tr><td colspan="3">‚öîÔ∏è No se encontraron resultados</td></tr>';
        return;
      }

      filtered.forEach(item => {
        const tr = document.createElement('tr');

        const tdMap = document.createElement('td');
        tdMap.className = 'map-name';
        tdMap.textContent = item.map;

        const tdGuilds = document.createElement('td');
        tdGuilds.className = 'guilds';
        item.guilds.forEach(g => {
          const gdiv = document.createElement('div');
          gdiv.className = 'guild-row';
          const bullet = document.createElement('div'); bullet.className = 'bullet';
          const txt = document.createElement('div'); txt.className = 'guild-text';
          const nameSpan = document.createElement('span'); nameSpan.style.textTransform = 'none';
          nameSpan.textContent = g.name;
          const tag = document.createElement('span'); tag.className = 'tag ' + (g.type === 'HQ' ? 'hq' : 'ho'); tag.textContent = g.type;
          txt.appendChild(nameSpan);
          txt.appendChild(tag);
          gdiv.appendChild(bullet);
          gdiv.appendChild(txt);
          tdGuilds.appendChild(gdiv);
        });

        const tdAction = document.createElement('td');
        tdAction.className = 'action-cell';
        const editBtn = document.createElement('button');
        editBtn.className = 'action-edit'; editBtn.textContent = 'Editar';
        editBtn.onclick = () => startEditing(item);

        const delBtn = document.createElement('button');
        delBtn.className = 'action-del'; delBtn.textContent = 'Eliminar';
        delBtn.onclick = () => {
          Swal.fire({
            title: '¬øEliminar mapa?',
            text: `¬øSeguro que quieres eliminar "${item.map}"? (Eliminaci√≥n en Firestore)`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#e53935',
            confirmButtonText: 'S√≠, eliminar'
          }).then(res => {
            if (res.isConfirmed) {
              deleteDataFromFirestore(item.map);
            }
          });
        };

        const editorText = item.editorId ? ` (${item.editorId.substring(0, 4)}...)` : '';
        const histText = item.lastEdited ? `√öltima edici√≥n: ${item.lastEdited}${editorText}` : 'Nunca editado';
        const hist = document.createElement('div'); hist.className = 'history'; hist.textContent = histText;

        tdAction.appendChild(editBtn);
        tdAction.appendChild(delBtn);
        tdAction.appendChild(hist);

        tr.appendChild(tdMap);
        tr.appendChild(tdGuilds);
        tr.appendChild(tdAction);

        resultTableBody.appendChild(tr);
      });
    }

    // --- iniciar edici√≥n: llenar formulario con datos del mapa ---
    function startEditing(item) {
      // El ID de Firestore es el nombre del mapa, lo usamos como clave de edici√≥n
      editingMap = item.map; 
      mapInput.value = item.map;
      guildListContainer.innerHTML = '';
      if (Array.isArray(item.guilds) && item.guilds.length) {
        item.guilds.forEach(g => guildListContainer.appendChild(createGuildFormRow(g.name, g.type)));
      } else {
        guildListContainer.appendChild(createGuildFormRow('', 'HO'));
      }
      window.scrollTo({ top: document.getElementById('editor').offsetTop - 20, behavior: 'smooth' });
    }

    // --- aplicar agregar / editar ---
    applyBtn.addEventListener('click', async () => {
      const mapName = mapInput.value.trim();
      if (!mapName) {
        Swal.fire('Falta nombre', 'Escribe el nombre del mapa', 'warning');
        return;
      }

      // Validaci√≥n: Si est√°s editando un mapa y cambias el nombre, necesitas eliminar el viejo
      const isRename = editingMap && editingMap.toLowerCase() !== mapName.toLowerCase();
      
      const rows = Array.from(guildListContainer.children).map(row => {
        const name = (row.querySelector('input[type="text"]').value || '').trim();
        const type = (row.querySelector('select').value || 'HO');
        return { name, type };
      }).filter(g => g.name);

      if (rows.length === 0) {
        Swal.fire('Falta gremio', 'Agrega al menos un gremio con tipo HO/HQ', 'warning');
        return;
      }

      const mapItem = { map: mapName, guilds: rows };
      
      // 1. Si hubo un renombre, eliminamos el mapa viejo
      if (isRename) {
        const success = await deleteDataFromFirestore(editingMap);
        if (!success) {
           Swal.fire('Error', 'No se pudo eliminar el mapa viejo. Cancelando el guardado.', 'error');
           return;
        }
      }
      
      // 2. Guardamos el nuevo/actualizado mapa
      const success = await saveDataToFirestore(mapItem);
      
      if (success) {
        Swal.fire('Guardado', isRename || !editingMap ? 'Mapa agregado/renombrado y guardado en Firestore.' : 'Mapa actualizado y guardado en Firestore.', 'success');
        
        // Limpiar formulario si el guardado fue exitoso
        editingMap = null;
        mapInput.value = '';
        clearGuildForm();
      }
      // La tabla se actualizar√° autom√°ticamente gracias a onSnapshot.
    });

    // --- exportaci√≥n JSON (mantiene la funcionalidad) ---
    exportBtn.addEventListener('click', () => {
      try {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `atlas_albion_export_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        Swal.fire('‚úÖ Archivo exportado', 'Descarga iniciada', 'success');
      } catch (err) {
        console.error(err);
        Swal.fire('Error', 'No se pudo generar el archivo', 'error');
      }
    });

    // --- importaci√≥n JSON (nuevo bot√≥n) ---
    importLocalBtn.addEventListener('click', () => {
      Swal.fire({
          title: 'Importar JSON',
          text: "Esto cargar√° datos desde un archivo JSON y los guardar√° en Firestore, ¬°sobrescribiendo si los mapas ya existen!",
          icon: 'info',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          confirmButtonText: 'S√≠, importar archivo'
      }).then((result) => {
          if (result.isConfirmed) {
              fileInput.click();
          }
      })
    });

    fileInput.addEventListener('change', (e) => {
      const f = e.target.files[0];
      if (!f) return;
      
      const reader = new FileReader();
      reader.onload = async (ev) => {
        try {
          let text = ev.target.result;
          if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
          text = text.trim();
          let parsed = JSON.parse(text);
          if (!Array.isArray(parsed)) throw new Error('Se esperaba un array de mapas');
          
          // Normalizamos la data importada antes de subirla
          const dataToUpload = parsed.map(item => {
              const mapName = item.map || item.mapa || item.name || '';
              let guilds = item.guilds || item.gremios || [];
              if (!Array.isArray(guilds)) guilds = [];
              guilds = guilds.map(g => {
                if (typeof g === 'string') return { name: g, type: 'HO' };
                if (typeof g === 'object' && g !== null) {
                  return {
                    name: g.name || g.nombre || '',
                    type: (g.type === 'HQ' || g.type === 'HO') ? g.type : (g.tipo === 'HQ' || g.tipo === 'HO' ? g.tipo : 'HO')
                  };
                }
                return null;
              }).filter(Boolean);
              
              if (!mapName || guilds.length === 0) return null;
              
              const now = new Date().toLocaleString();
              return { map: mapName, guilds: guilds, lastEdited: now, editorId: userId };
          }).filter(Boolean);

          if (dataToUpload.length === 0) {
              Swal.fire('Advertencia', 'No se encontraron mapas v√°lidos para importar en el archivo.', 'warning');
              return;
          }
          
          // Usamos un batch para subir varios documentos a la vez
          const batch = writeBatch(db);
          const collectionPath = getCollectionPath();
          
          dataToUpload.forEach(item => {
              const docRef = doc(db, collectionPath, item.map);
              batch.set(docRef, item, { merge: false });
          });
          
          await batch.commit();
          Swal.fire('‚úÖ Importado y Guardado', `Se importaron ${dataToUpload.length} mapas a Firestore.`, 'success');

        } catch (err) {
          console.error('Error procesando JSON:', err);
          Swal.fire('‚ùå Error', 'No se pudo leer o procesar el archivo JSON.', 'error');
        } finally {
          fileInput.value = '';
        }
      };
      reader.onerror = () => { Swal.fire('‚ùå Error', 'No se pudo leer el archivo', 'error'); fileInput.value = ''; };
      reader.readAsText(f, 'UTF-8');
    });

    // --- busqueda ---
    searchInput.addEventListener('input', (e) => renderResults(e.target.value));

    // --- tema (palanca) ---
    function applyTheme(theme) {
      const light = theme === 'light';
      bodyEl.classList.toggle('light', light);
      themeSwitch.classList.toggle('on', light);
      localStorage.setItem('theme', theme);
    }
    themeSwitch.addEventListener('click', () => {
      const newT = bodyEl.classList.contains('light') ? 'dark' : 'light';
      applyTheme(newT);
    });
    themeSwitch.addEventListener('keydown', (e) => { if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); themeSwitch.click(); }});
    applyTheme(localStorage.getItem('theme') || 'dark');

    // --- inicializacion --
    // La data se cargar√° autom√°ticamente cuando onAuthStateChanged se complete y llame a setupRealtimeListener
    clearGuildForm();

    // Reemplazamos el antiguo bot√≥n de 'Guardar en Radar (localStorage)'
    saveBtn.addEventListener('click', () => {
        // En este nuevo esquema, el guardado es autom√°tico con el bot√≥n 'Agregar/Guardar'. 
        // Este bot√≥n se convierte en un indicador de que estamos usando Firestore
        Swal.fire('Sincronizaci√≥n', 'Los cambios se guardan autom√°ticamente en Firebase Firestore al usar "Agregar / Guardar".', 'info');
    });
    
  </script>
</body>
</html>