<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>ATLAS - Albion Online</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body { font-family: Arial; background:#1b1b1b; color:white; padding:20px; }
    .box { background:#2a2a2a; padding:15px; border-radius:10px; max-width:700px; margin:auto; }
    input, select { width:100%; padding:10px; margin-top:6px; margin-bottom:10px; }
    button { padding:10px 15px; border:none; border-radius:5px; background:#008cff; color:white; cursor:pointer; }
    button.delete { background:#d9534f; }
    .map-item { background:#333; padding:10px; border-radius:8px; margin-top:10px; }
  </style>
</head>
<body>

<div class="box">
  <h1>ATLAS - Firebase</h1>

  <h3>Agregar mapa</h3>
  <input id="mapName" type="text" placeholder="Nombre del mapa">

  <div id="guilds"></div>

  <button onclick="addGuildRow()">+ Agregar Gremio</button>
  <br><br>
  <button onclick="saveMap()">Guardar en Firebase</button>

  <h2 style="margin-top:30px;">Mapas guardados</h2>
  <div id="mapsList"></div>

</div>

<script type="module">

/* ------------------------ IMPORTS FIREBASE ------------------------ */

import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { 
  getFirestore, collection, addDoc, getDocs, onSnapshot, deleteDoc, doc 
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* ------------------------ CONFIGURACIÓN TUYA ------------------------ */

const firebaseConfig = {
  apiKey: "AIzaSyAy56huxeutt4fzmxDXMDSQGNomaIf9vSw",
  authDomain: "atlas-albion-3f535.firebaseapp.com",
  projectId: "atlas-albion-3f535",
  storageBucket: "atlas-albion-3f535.firebasestorage.app",
  messagingSenderId: "734860667304",
  appId: "1:734860667304:web:211782caf5da8ccb61959d"
};

/* ------------------------ INICIALIZACIÓN ------------------------ */

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const mapasRef = collection(db, "mapas");

/* ------------------------ FUNCIONES ------------------------ */

// Crear fila para gremio
function addGuildRow(name = "", type = "HO") {
  const container = document.getElementById("guilds");

  const div = document.createElement("div");
  div.innerHTML = `
    <input class="gname" type="text" placeholder="Nombre del gremio" value="${name}">
    <select class="gtype">
      <option value="HO" ${type=="HO"?"selected":""}>HO</option>
      <option value="HQ" ${type=="HQ"?"selected":""}>HQ</option>
    </select>
  `;

  container.appendChild(div);
}

// Guardar mapa en Firestore
async function saveMap() {
  const mapName = document.getElementById("mapName").value.trim();
  if (!mapName) {
    alert("Escribe el nombre del mapa");
    return;
  }

  const gnames = document.querySelectorAll(".gname");
  const gtypes = document.querySelectorAll(".gtype");

  let guilds = [];

  for (let i = 0; i < gnames.length; i++) {
    if (gnames[i].value.trim() !== "") {
      guilds.push({
        name: gnames[i].value,
        type: gtypes[i].value
      });
    }
  }

  if (guilds.length === 0) {
    alert("Agrega al menos un gremio");
    return;
  }

  await addDoc(mapasRef, {
    map: mapName,
    guilds: guilds,
    lastEdited: new Date().toLocaleString()
  });

  document.getElementById("mapName").value = "";
  document.getElementById("guilds").innerHTML = "";

  alert("Mapa guardado en Firebase ✅");
}

// Mostrar mapas (SE ACTUALIZA EN TIEMPO REAL)
onSnapshot(mapasRef, (snapshot) => {
  const list = document.getElementById("mapsList");
  list.innerHTML = "";

  snapshot.forEach((d) => {
    const data = d.data();
    const div = document.createElement("div");
    div.className = "map-item";

    div.innerHTML = `
      <b>${data.map}</b><br>
      ${data.guilds.map(g => `• ${g.name} (${g.type})`).join("<br>")}
      <br><br>
      <button class="delete" onclick="deleteMap('${d.id}')">Eliminar</button>
    `;

    list.appendChild(div);
  });
});

// Eliminar mapa
window.deleteMap = async function(id) {
  await deleteDoc(doc(db, "mapas", id));
  alert("Mapa eliminado ❌");
};

addGuildRow();

</script>

</body>
</html>
