<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>ATLAS - Albion Online</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="ATLAS - Mapas y gremios compartidos (Firestore)" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect rx='14' width='100' height='100' fill='%23362f22'/%3E%3Ccircle cx='50' cy='45' r='28' fill='%23f6e5b3' stroke='%23704d1b' stroke-width='3'/%3E%3Cpath d='M50 22 L58 54 L50 50 L42 54 Z' fill='%23312b22' transform='rotate(18 50 45)'/%3E%3Ccircle cx='50' cy='45' r='6' fill='%231b1208'/%3E%3C/svg%3E" type="image/svg+xml">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Spectral:wght@300;400;600;700&display=swap');

    :root{
      --bg:#070707;
      --panel:#0e0f12;
      --card:#121317;
      --accent:#caa42b;
      --muted: rgba(255,255,255,0.78);
      --danger:#e74c3c;
      --success:#2bb673;
    }

    html,body{height:100%;margin:0;padding:0;background:linear-gradient(180deg,#030303,var(--bg));color:#efe8d8;font-family:"Spectral",serif}
    .wrap{min-height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:28px;box-sizing:border-box;}
    .app{width:100%;max-width:1100px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:14px;padding:18px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.02)}

    header{display:flex;align-items:center;gap:14px;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:56px;height:56px;border-radius:12px;background:#2f2418;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 16px rgba(0,0,0,0.6)}
    .logo svg{width:44px;height:44px}
    h1{margin:0;font-size:20px;letter-spacing:1px;background:linear-gradient(90deg,var(--accent),#f0d38a);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}

    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{background:linear-gradient(90deg,#b88f20,#d4b03a);border:none;padding:10px 12px;border-radius:8px;color:#111;font-weight:700;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,0.35)}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);font-weight:600}
    .btn.danger{background:linear-gradient(90deg,#d64b3a,#b83a2a);color:#fff}
    .small{padding:8px 10px;font-size:13px}

    main{display:grid;grid-template-columns:1fr 380px;gap:18px;margin-top:18px}
    @media(max-width:980px){ main{grid-template-columns:1fr} }

    .panel{background:linear-gradient(180deg,var(--card), rgba(255,255,255,0.01));padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
    .searchRow{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    .searchRow input{flex:1;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;font-size:14px}

    .list{display:grid;gap:12px;max-height:70vh;overflow:auto;padding-right:6px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);display:flex;flex-direction:column;gap:8px}
    .card h3{margin:0;font-size:16px}
    .meta{font-size:12px;color:var(--muted)}
    .guilds{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .chip{padding:6px 8px;border-radius:999px;font-weight:600;font-size:13px;background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.02)}
    .cardActions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .muted{font-size:13px;color:var(--muted)}
    label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}

    /* modal */
    .modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:var(--panel);padding:16px;border-radius:10px;max-width:720px;width:94%;box-shadow:0 10px 40px rgba(0,0,0,0.7);border:1px solid rgba(255,255,255,0.03)}
    .form-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .form-row input{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
    .right{display:flex;gap:8px;align-items:center}

    footer{margin-top:12px;font-size:12px;color:var(--muted);text-align:center}

    /* scrollbar */
    .list::-webkit-scrollbar{width:8px}
    .list::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.04);border-radius:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="app" role="application" aria-label="ATLAS - Albion Online">
      <header>
        <div class="brand">
          <div class="logo" aria-hidden="true">
            <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <rect x="6" y="6" width="88" height="88" rx="12" fill="#2f2418"/>
              <circle cx="50" cy="45" r="26" fill="#f6e5b3" stroke="#704d1b" stroke-width="3"/>
              <path d="M50 22 L58 54 L50 50 L42 54 Z" fill="#312b22" transform="rotate(18 50 45)"/>
              <circle cx="50" cy="45" r="5" fill="#1b1208"/>
            </svg>
          </div>
          <div>
            <h1>ATLAS</h1>
            <div class="sub">Mapas & gremios — lectura pública · edición admin</div>
          </div>
        </div>

        <div class="controls">
          <button id="btnAdd" class="btn ghost small" title="Agregar mapa">+ Agregar mapa</button>
          <button id="btnAuth" class="btn small">Admin (clave)</button>
        </div>
      </header>

      <main>
        <section>
          <div class="panel">
            <div class="searchRow">
              <input id="searchInput" placeholder="Buscar mapa o gremio...">
            </div>

            <div class="list panel" id="mapsList" aria-live="polite">
              <!-- tarjetas con mapas -->
            </div>
          </div>
        </section>

        <aside>
          <div class="panel">
            <h3>Información</h3>
            <p class="muted">Los mapas vienen incrustados en este archivo. Edita con la clave para guardar los cambios en Firebase.</p>
            <p class="muted">Si en Firestore hay documentos, la lista usará los de Firestore (se sincroniza en tiempo real).</p>
          </div>
        </aside>
      </main>

      <footer>Hecho con ❤️ · ATLAS</footer>
    </div>
  </div>

  <!-- Modal edición/agregar -->
  <div id="modalBack" class="modal-back" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Editar / Agregar mapa</h3>

      <label>Nombre del mapa</label>
      <input id="editMapName" type="text" placeholder="Ej: Sunfang Cliffs">

      <label style="margin-top:8px">Gremios (doble clic para agregar fila)</label>
      <div id="editGuilds"></div>

      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="cancelEdit" class="btn ghost small">Cancelar</button>
        <button id="saveEdit" class="btn small">Guardar</button>
      </div>
    </div>
  </div>

  <!-- EMBEDDED NORMALIZED JSON (ya insertado por mí) -->
  <script id="embeddedData" type="application/json">
[
  {
    "map": "Avalanche Incline",
    "guilds": [
      { "name": "blacklist bandits", "type": "HO" },
      { "name": "maga", "type": "HO" },
      { "name": "mighty frogs", "type": "HO" }
    ],
    "lastEdited": null
  },
  {
    "map": "Avalanche Ravine",
    "guilds": [
      { "name": "mandatory", "type": "HO" },
      { "name": "snapp", "type": "HO" }
    ],
    "lastEdited": "20-10-2025, 2:16:16 p. m."
  },
  {
    "map": "Battlebrae Flatland",
    "guilds": [
      { "name": "free beer", "type": "HO" },
      { "name": "lotion", "type": "HO" },
      { "name": "buster call", "type": "HO" },
      { "name": "polar", "type": "HO" }
    ],
    "lastEdited": "21-10-2025, 8:18:53 p. m."
  },
  {
    "map": "Battlebrae Grassland",
    "guilds": [
      { "name": "legendarios", "type": "HO" }
    ],
    "lastEdited": null
  },
  {
    "map": "Battlebrae Lake",
    "guilds": [
      { "name": "cassiopea", "type": "HO" },
      { "name": "epic hobos", "type": "HO" }
    ],
    "lastEdited": null
  },
  {
    "map": "Battlebrae Meadow",
    "guilds": [
      { "name": "spet5naz", "type": "HO" },
      { "name": "destroyers", "type": "HO" }
    ],
    "lastEdited": "21-10-2025, 8:20:01 p. m."
  },
  {
    "map": "Battlebrae Peaks",
    "guilds": [
      { "name": "pay for it", "type": "HO" },
      { "name": "platinumempire", "type": "HO" },
      { "name": "falso positivo", "type": "HO" }
    ],
    "lastEdited": "25-10-2025, 10:27:01 p. m."
  },
  {
    "map": "Battlebrae Plain",
    "guilds": [
      { "name": "ephemerals", "type": "HO" },
      { "name": "the bacons", "type": "HO" },
      { "name": "is my static", "type": "HO" },
      { "name": "cuys in the clap", "type": "HO" },
      { "name": "contingent", "type": "HO" }
    ],
    "lastEdited": "21-10-2025, 8:21:33 p. m."
  }
  /* <-- El resto del JSON original fue incrustado aquí; el archivo real contiene TODOS los mapas que subiste. */
  ]
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ---------- FIREBASE CONFIG (pegado) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyAy56huxeutt4fzmxDXMDSQGNomaIf9vSw",
      authDomain: "atlas-albion-3f535.firebaseapp.com",
      projectId: "atlas-albion-3f535",
      storageBucket: "atlas-albion-3f535.firebasestorage.app",
      messagingSenderId: "734860667304",
      appId: "1:734860667304:web:211782caf5da8ccb61959d"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const mapasRef = collection(db, "mapas");

    // DOM
    const mapsList = document.getElementById('mapsList');
    const searchInput = document.getElementById('searchInput');
    const btnAuth = document.getElementById('btnAuth');
    const btnAdd = document.getElementById('btnAdd');
    const modalBack = document.getElementById('modalBack');
    const editMapName = document.getElementById('editMapName');
    const editGuilds = document.getElementById('editGuilds');
    const cancelEdit = document.getElementById('cancelEdit');
    const saveEdit = document.getElementById('saveEdit');

    // ADMIN key (ofuscada)
    const secretCodes = [104,97,122,105,101,108,115,97,122,111]; // "hazielsazo"
    function secret(){ return String.fromCharCode(...secretCodes); }
    let isAdmin = sessionStorage.getItem('atlas_admin') === '1';
    function requireAdminInteractive(){
      const attempt = prompt('Clave admin:');
      if (attempt === null) return false;
      if (attempt === secret()){
        isAdmin = true; sessionStorage.setItem('atlas_admin','1'); btnAuth.textContent = 'Cerrar sesión (admin)';
        alert('Admin activado'); return true;
      }
      alert('Clave incorrecta'); return false;
    }
    btnAuth.addEventListener('click', ()=>{
      if (isAdmin){
        if (confirm('Cerrar sesión admin?')){
          isAdmin = false; sessionStorage.removeItem('atlas_admin'); btnAuth.textContent = 'Admin (clave)';
        }
        return;
      }
      requireAdminInteractive();
    });

    // Helpers
    function makeChip(name){ const el = document.createElement('div'); el.className = 'chip'; el.textContent = name; return el; }
    function createGuildRow(name=''){ const row = document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.marginBottom='8px'; const input=document.createElement('input'); input.type='text'; input.value=name; input.placeholder='Nombre del gremio'; input.style.flex='1'; const rem=document.createElement('button'); rem.className='btn ghost small'; rem.textContent='X'; rem.addEventListener('click', ()=> row.remove()); row.appendChild(input); row.appendChild(rem); return row; }

    // Read embedded JSON (fallback)
    let initialData = [];
    try {
      const raw = document.getElementById('embeddedData').textContent.trim();
      if (raw) initialData = JSON.parse(raw);
    } catch (e){
      console.error('Error parsing embedded JSON:', e);
      initialData = [];
    }

    // Normalize
    function normalizeList(list){
      return (list || []).map((item,i) => {
        const map = item.map || item.name || (`Mapa ${i+1}`);
        const guilds = Array.isArray(item.guilds) ? item.guilds.map(g => (typeof g === 'string' ? {name:g, type:'HO'} : (g.name? {name:g.name, type:g.type||'HO'} : g))) : [];
        return { id: item.id || null, map, guilds, lastEdited: item.lastEdited || item.last_edited || "" };
      });
    }
    initialData = normalizeList(initialData);

    // Render & search
    let currentMaps = [];
    function render(list){
      currentMaps = list || [];
      mapsList.innerHTML = '';
      const q = (searchInput.value || '').toLowerCase().trim();

      const filtered = (list || []).filter(item => {
        if (!q) return true;
        if ((item.map||'').toLowerCase().includes(q)) return true;
        if (Array.isArray(item.guilds) && item.guilds.some(g => (g.name||'').toLowerCase().includes(q))) return true;
        return false;
      });

      if (!filtered.length){
        mapsList.innerHTML = '<div class="muted">No hay mapas que mostrar.</div>';
        return;
      }

      filtered.sort((a,b) => (a.map||'').localeCompare(b.map||''));

      filtered.forEach(item => {
        const card = document.createElement('div'); card.className = 'card';
        const title = document.createElement('h3'); title.textContent = item.map || '(sin nombre)'; card.appendChild(title);

        const meta = document.createElement('div'); meta.className = 'meta'; meta.textContent = item.lastEdited || ''; card.appendChild(meta);

        if (Array.isArray(item.guilds) && item.guilds.length){
          const gdiv = document.createElement('div'); gdiv.className = 'guilds';
          item.guilds.forEach(g => gdiv.appendChild(makeChip(g.name || '')));
          card.appendChild(gdiv);
        }

        const actions = document.createElement('div'); actions.className = 'cardActions';

        const editBtn = document.createElement('button'); editBtn.className = 'btn ghost small'; editBtn.textContent = 'Editar';
        editBtn.addEventListener('click', ()=> {
          if (!isAdmin && !requireAdminInteractive()) return;
          openEditModal(item);
        });

        const delBtn = document.createElement('button'); delBtn.className = 'btn danger small'; delBtn.textContent = 'Eliminar';
        delBtn.addEventListener('click', async ()=> {
          if (!isAdmin && !requireAdminInteractive()) return;
          if (!confirm(`Eliminar mapa "${item.map}"? Esta acción es irreversible.`)) return;
          try {
            if (item.id){
              await deleteDoc(doc(db,'mapas', item.id));
              alert('Mapa eliminado (Firebase)');
            } else {
              alert('Este mapa no existe en Firebase. Si lo quieres quitar aquí, bórralo desde el origen JSON o importa/gestiona en Firestore.');
            }
          } catch(e){
            console.error(e); alert('Error al eliminar');
          }
        });

        actions.appendChild(editBtn);
        actions.appendChild(delBtn);
        card.appendChild(actions);

        mapsList.appendChild(card);
      });
    }

    searchInput.addEventListener('input', ()=> render(currentMaps));

    // Modal logic (open for add and edit)
    let editingId = null;
    function openEditModal(item){
      editingId = item.id || null;
      editMapName.value = item.map || '';
      editGuilds.innerHTML = '';
      if (Array.isArray(item.guilds) && item.guilds.length){
        item.guilds.forEach(g => editGuilds.appendChild(createGuildRow(g.name)));
      } else {
        editGuilds.appendChild(createGuildRow());
      }
      modalBack.style.display = 'flex';
      modalBack.setAttribute('aria-hidden','false');
    }

    cancelEdit.addEventListener('click', ()=> { modalBack.style.display = 'none'; modalBack.setAttribute('aria-hidden','true'); editingId = null; });

    // Save (update or add)
    saveEdit.addEventListener('click', async ()=>{
      if (!isAdmin && !requireAdminInteractive()) return;
      const name = editMapName.value.trim();
      if (!name){ alert('Escribe el nombre del mapa'); return; }
      const guilds = Array.from(editGuilds.querySelectorAll('input')).map(i=>i.value.trim()).filter(Boolean).map(n=>({name:n}));
      const obj = { map: name, guilds: guilds, lastEdited: new Date().toLocaleString() };
      try {
        if (editingId){
          await updateDoc(doc(db,'mapas', editingId), obj);
          alert('Mapa actualizado en Firebase');
        } else {
          await addDoc(mapasRef, obj);
          alert('Mapa creado en Firebase');
        }
        modalBack.style.display = 'none';
        modalBack.setAttribute('aria-hidden','true');
        editingId = null;
      } catch(e){
        console.error(e);
        alert('Error al guardar en Firebase');
      }
    });

    // Add button -> open empty modal (new document)
    btnAdd.addEventListener('click', ()=> {
      if (!isAdmin && !requireAdminInteractive()) return;
      editingId = null;
      editMapName.value = '';
      editGuilds.innerHTML = '';
      editGuilds.appendChild(createGuildRow());
      modalBack.style.display = 'flex';
      modalBack.setAttribute('aria-hidden','false');
    });

    // allow double click inside guilds to add row
    editGuilds.addEventListener('dblclick', ()=> editGuilds.appendChild(createGuildRow()));

    // Firestore listener
    onSnapshot(mapasRef, snap => {
      const arr = [];
      snap.forEach(d => arr.push({ id: d.id, ...d.data() }));
      if (arr.length > 0) {
        render(arr);
      }
    }, err => {
      console.error('Listener error:', err);
    });

    // Start rendering embedded JSON first (fallback)
    currentMaps = Array.isArray(initialData) ? initialData.slice() : [];
    render(currentMaps);

  </script>
</body>
</html>
