<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>ATLAS - Albion Online</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&display=swap');

    :root {
      --gold-1:#d4af37; --gold-2:#c29b2d;
      --bg-dark:#0f0f10; --bg-light:#f3efe1;
      --panel-dark:rgba(0,0,0,0.72); --panel-light:rgba(255,255,245,0.92);
      --accent-ho:#0b66ff; --accent-hq:#23a34a; --danger:#e53935;
      --text-light:#f7f2ea; --text-dark:#111;
      --muted: rgba(255,255,255,0.65);
    }

    html,body{height:100%;margin:0;padding:0;font-family:"Cinzel",serif}
    body{
      background: linear-gradient(180deg,var(--bg-dark),#070707);
      color:var(--text-light);
      min-height:100vh;
      padding:28px;
      display:flex;
      justify-content:center;
      box-sizing:border-box;
      transition:background .25s,color .25s;
    }
    body.light{
      background: var(--bg-light);
      color:var(--text-dark);
    }

    .container{
      width:100%;
      max-width:980px;
      background:var(--panel-dark);
      border-radius:12px;
      padding:22px;
      box-shadow:0 10px 30px rgba(0,0,0,0.6);
      backdrop-filter:blur(4px);
      transition:background .25s, color .25s;
    }
    body.light .container{ background:var(--panel-light); box-shadow:0 8px 18px rgba(0,0,0,0.08); }

    .header-row{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px; }
    h1{ margin:0; font-size:28px; letter-spacing:1px; background:linear-gradient(90deg,var(--gold-1),var(--gold-2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }

    /* small switch (palanca) */
    .theme-switch{ display:flex; align-items:center; gap:8px; font-size:13px; user-select:none; }
    .switch{ width:46px; height:24px; background:rgba(255,255,255,0.12); border-radius:999px; position:relative; cursor:pointer; }
    body.light .switch{ background:rgba(0,0,0,0.06); }
    .knob{ position:absolute; top:2px; left:2px; width:20px; height:20px; border-radius:50%; background:linear-gradient(180deg,#fff,#ddd); box-shadow:0 2px 6px rgba(0,0,0,0.25); transition:left .18s; }
    .switch.on .knob{ left:24px; }

    .controls-row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:14px; }
    .search-input{ flex:1 1 420px; }

    input[type="text"], select {
      width:100%; padding:10px 12px; border-radius:6px; border:1px solid rgba(0,0,0,0.12);
      background: rgba(255,255,255,0.02); color:inherit; box-sizing:border-box; font-size:14px;
    }
    body.light input[type="text"], body.light select { background: rgba(0,0,0,0.02); color:var(--text-dark); }

    .btn{ padding:10px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:700; }
    .btn.small{ padding:7px 10px; font-size:13px; }
    .btn.save{ background:linear-gradient(90deg,var(--gold-1),var(--gold-2)); color:#111; }
    .btn.load{ background:#8b6f2a; color:white; }
    .btn.add{ background:#2d6a2b; color:white; }
    .btn.gray{ background:#6b6b6b; color:white; }

    table{ width:100%; border-collapse:collapse; margin-top:8px; font-size:14px; }
    th, td{ padding:12px 10px; border-bottom:1px solid rgba(255,255,255,0.04); text-align:left; vertical-align:top; }
    body.light th, body.light td{ border-color: rgba(0,0,0,0.06); }
    th{ color:var(--gold-1); font-weight:700; background: rgba(0,0,0,0.06); }

    td.map-name{ font-weight:700; width:28%; text-transform: none; }
    td.guilds{ width:50%; }

    /* gremios: viñeta dorada y lista vertical */
    .guild-row{ margin-bottom:8px; display:flex; align-items:center; gap:10px; }
    .bullet{ width:10px; height:10px; border-radius:50%; background:var(--gold-1); flex:0 0 10px; margin-left:-2px; margin-top:3px; }
    .guild-text{ display:flex; align-items:center; gap:8px; font-weight:600; text-transform:uppercase; font-size:13px; }
    .tag{ padding:3px 8px; border-radius:999px; font-size:12px; font-weight:800; color:#fff; }
    .tag.ho{ background:var(--accent-ho); } .tag.hq{ background:var(--accent-hq); }

    .action-cell{ display:flex; flex-direction:column; gap:8px; align-items:flex-start; }
    .action-cell button{ width:120px; padding:8px 10px; border-radius:8px; font-weight:700; cursor:pointer; }
    .action-edit{ background: linear-gradient(90deg,#ff9800,#ffb366); border:none; color:#111; }
    .action-del{ background: linear-gradient(90deg,#e53935,#b71c1c); border:none; color:#fff; }

    .history{ font-size:12px; color:var(--muted); }
    body.light .history{ color: rgba(0,0,0,0.6); }

    /* Form area */
    .form{ margin-top:16px; padding-top:12px; border-top:1px dashed rgba(255,255,255,0.04); }
    .form h3{ margin:0 0 8px 0; color:var(--gold-1); }
    .form .top-row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:10px; }
    .form input[type="text"]{ flex:1 1 360px; padding:10px; }
    .row-guild{ display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    .row-guild input[type="text"]{ flex:1; padding:8px; }
    .row-guild select{ width:140px; padding:8px; }
    .remove-guild{ background:transparent; color:var(--danger); border:none; cursor:pointer; font-weight:700; padding:6px 8px; }

    .add-guild-btn{ background:rgba(255,255,255,0.03); padding:8px 10px; border-radius:6px; cursor:pointer; color:inherit; border:1px solid rgba(0,0,0,0.06); }

    @media (max-width:760px){ .action-cell button{ width:100%; } .header-row{ flex-direction:column; align-items:flex-start; gap:10px; } }
  </style>
</head>
<body>
  <div class="container" role="application" aria-label="ATLAS - Albion Online">
    <div class="header-row">
      <h1>ATLAS - Albion Online</h1>

      <div style="display:flex; align-items:center; gap:12px;">
        <div class="theme-switch" title="Alternar tema">
          <div style="font-size:12px; font-weight:700; opacity:.9">Tema</div>
          <div id="themeSwitch" class="switch" role="button" tabindex="0"><div class="knob"></div></div>
        </div>
        </div>
    </div>

    <div class="controls-row">
      <input id="searchInput" class="search-input" type="text" placeholder="Buscar mapa o gremio...">
    </div>

    <table aria-live="polite" id="mainTable">
      <thead><tr><th>Mapa</th><th>Gremios</th><th>Acción</th></tr></thead>
      <tbody id="resultTableBody"></tbody>
    </table>

    <div class="form" id="editor">
      <h3>Agregar / Editar</h3>

      <div class="top-row">
        <input id="mapInput" type="text" placeholder="Nombre del mapa (ej. Sunfang Cliffs)">
        <button id="addGuildRow" class="add-guild-btn">+ Agregar gremio</button>
      </div>

      <div id="guildListContainer" aria-label="Lista de gremios para el formulario" style="margin-bottom:6px"></div>

      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button id="applyBtn" class="btn add">Agregar / Guardar</button>
        <button id="clearForm" class="btn small">Limpiar</button>
      </div>
    </div>
  </div>

  <script>
    // --- estado y referencias ---
    let data = []; // Inicializamos data vacía, se cargará desde JSON
    let editingMap = null; // si editando, contiene el nombre original
    const resultTableBody = document.getElementById('resultTableBody');
    const searchInput = document.getElementById('searchInput');
    // const saveBtn = document.getElementById('saveBtn'); // Eliminado
    // const loadBtn = document.getElementById('loadBtn'); // Eliminado
    // const fileInput = document.getElementById('fileInput'); // Eliminado
    const themeSwitch = document.getElementById('themeSwitch');
    const bodyEl = document.body;

    const mapInput = document.getElementById('mapInput');
    const guildListContainer = document.getElementById('guildListContainer');
    const addGuildRowBtn = document.getElementById('addGuildRow');
    const applyBtn = document.getElementById('applyBtn');
    // const saveLocalBtn = document.getElementById('saveLocalBtn'); // Eliminado
    const clearFormBtn = document.getElementById('clearForm');

    // --- helpers para filas de gremio en form ---
    function createGuildFormRow(name = '', type = 'HO') {
      const wrapper = document.createElement('div');
      wrapper.className = 'row-guild';

      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'Nombre del gremio';
      input.value = name;

      const select = document.createElement('select');
      const o1 = new Option('HO (Hideout)', 'HO');
      const o2 = new Option('HQ (Headquarters)', 'HQ');
      select.add(o1); select.add(o2);
      select.value = type;

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'remove-guild';
      removeBtn.title = 'Eliminar este gremio';
      removeBtn.textContent = 'X';
      removeBtn.onclick = () => wrapper.remove();

      wrapper.appendChild(input);
      wrapper.appendChild(select);
      wrapper.appendChild(removeBtn);
      return wrapper;
    }

    function clearGuildForm() {
      guildListContainer.innerHTML = '';
      guildListContainer.appendChild(createGuildFormRow('', 'HO'));
    }

    addGuildRowBtn.addEventListener('click', (e) => { e.preventDefault(); guildListContainer.appendChild(createGuildFormRow('', 'HO')); });
    clearFormBtn.addEventListener('click', () => { editingMap = null; mapInput.value = ''; clearGuildForm(); });

    // --- normalizar datos: convertir guild string -> {name,type} (Mantenido para compatibilidad si la fuente JSON varía) ---
    function normalizeData() {
      data = (data || []).map(item => {
        if (!item || typeof item !== 'object') return null;
        const mapName = item.map || item.mapa || item.name || '';
        let guilds = item.guilds || item.gremios || [];
        if (!Array.isArray(guilds)) guilds = [];
        guilds = guilds.map(g => {
          if (typeof g === 'string') return { name: g, type: 'HO' };
          if (typeof g === 'object' && g !== null) {
            return {
              name: g.name || g.nombre || '',
              type: (g.type === 'HQ' || g.type === 'HO') ? g.type : (g.tipo === 'HQ' || g.tipo === 'HO' ? g.tipo : 'HO')
            };
          }
          return null;
        }).filter(Boolean);
        const lastEdited = item.lastEdited || item.ultimaEdicion || item.last_edit || null;
        return { map: mapName, guilds, lastEdited };
      }).filter(Boolean);
    }

    // --- renderizar tabla ---
    function renderResults(filter = '') {
      const q = (filter || '').trim().toLowerCase();
      resultTableBody.innerHTML = '';
      if (!Array.isArray(data) || data.length === 0) {
        resultTableBody.innerHTML = '<tr><td colspan="3">⚔️ No hay mapas cargados</td></tr>';
        return;
      }

      const filtered = data.filter(item => {
        if (!q) return true;
        if ((item.map || '').toLowerCase().includes(q)) return true;
        if (item.guilds.some(g => (g.name || '').toLowerCase().includes(q))) return true;
        return false;
      });

      if (filtered.length === 0) {
        resultTableBody.innerHTML = '<tr><td colspan="3">⚔️ No se encontraron resultados</td></tr>';
        return;
      }

      filtered.forEach(item => {
        const tr = document.createElement('tr');

        const tdMap = document.createElement('td');
        tdMap.className = 'map-name';
        tdMap.textContent = item.map;

        const tdGuilds = document.createElement('td');
        tdGuilds.className = 'guilds';
        item.guilds.forEach(g => {
          const gdiv = document.createElement('div');
          gdiv.className = 'guild-row';
          const bullet = document.createElement('div'); bullet.className = 'bullet';
          const txt = document.createElement('div'); txt.className = 'guild-text';
          const nameSpan = document.createElement('span'); nameSpan.style.textTransform = 'none';
          nameSpan.textContent = g.name;
          const tag = document.createElement('span'); tag.className = 'tag ' + (g.type === 'HQ' ? 'hq' : 'ho'); tag.textContent = g.type;
          txt.appendChild(nameSpan);
          txt.appendChild(tag);
          gdiv.appendChild(bullet);
          gdiv.appendChild(txt);
          tdGuilds.appendChild(gdiv);
        });

        const tdAction = document.createElement('td');
        tdAction.className = 'action-cell';
        const editBtn = document.createElement('button');
        editBtn.className = 'action-edit'; editBtn.textContent = 'Editar';
        editBtn.onclick = () => startEditing(item);

        const delBtn = document.createElement('button');
        delBtn.className = 'action-del'; delBtn.textContent = 'Eliminar';
        delBtn.onclick = () => {
          Swal.fire({
            title: '¿Eliminar mapa?',
            text: `¿Seguro que quieres eliminar "${item.map}"?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#e53935',
            confirmButtonText: 'Sí, eliminar'
          }).then(res => {
            if (res.isConfirmed) {
              data = data.filter(d => d.map !== item.map);
              // NOTA: No hay persistencia aquí, el cambio solo es local en la sesión
              renderResults(searchInput.value);
              Swal.fire('Eliminado', 'Mapa eliminado correctamente (solo en esta sesión)', 'success');
            }
          });
        };

        const hist = document.createElement('div'); hist.className = 'history'; hist.textContent = item.lastEdited ? `Última edición: ${item.lastEdited}` : 'Nunca editado';

        tdAction.appendChild(editBtn);
        tdAction.appendChild(delBtn);
        tdAction.appendChild(hist);

        tr.appendChild(tdMap);
        tr.appendChild(tdGuilds);
        tr.appendChild(tdAction);

        resultTableBody.appendChild(tr);
      });
    }

    // --- iniciar edición: llenar formulario con datos del mapa ---
    function startEditing(item) {
      editingMap = item.map;
      mapInput.value = item.map;
      guildListContainer.innerHTML = '';
      if (Array.isArray(item.guilds) && item.guilds.length) {
        item.guilds.forEach(g => guildListContainer.appendChild(createGuildFormRow(g.name, g.type)));
      } else {
        guildListContainer.appendChild(createGuildFormRow('', 'HO'));
      }
      window.scrollTo({ top: document.getElementById('editor').offsetTop - 20, behavior: 'smooth' });
    }

    // --- aplicar agregar / editar ---
    applyBtn.addEventListener('click', () => {
      const mapName = mapInput.value.trim();
      if (!mapName) {
        Swal.fire('Falta nombre', 'Escribe el nombre del mapa', 'warning');
        return;
      }

      const rows = Array.from(guildListContainer.children).map(row => {
        const name = (row.querySelector('input[type="text"]').value || '').trim();
        const type = (row.querySelector('select').value || 'HO');
        return { name, type };
      }).filter(g => g.name);

      if (rows.length === 0) {
        Swal.fire('Falta gremio', 'Agrega al menos un gremio con tipo HO/HQ', 'warning');
        return;
      }

      const now = new Date().toLocaleString();
      const idx = data.findIndex(d => d.map.toLowerCase() === (editingMap || mapName).toLowerCase());

      if (idx >= 0) {
        data[idx].map = mapName;
        data[idx].guilds = rows;
        data[idx].lastEdited = now;
        Swal.fire('Actualizado', 'Mapa actualizado correctamente (solo en esta sesión)', 'success');
      } else {
        data.push({ map: mapName, guilds: rows, lastEdited: now });
        Swal.fire('Agregado', 'Mapa agregado al Atlas (solo en esta sesión)', 'success');
      }

      editingMap = null;
      // NOTA: No hay persistencia aquí. Los datos se pierden al recargar.
      renderResults(searchInput.value);
      mapInput.value = '';
      clearGuildForm();
    });

    // --- Carga inicial de datos desde un archivo JSON (asumiendo que está en el mismo servidor/Netlify) ---
    // NOTA: El archivo debe llamarse 'albionData.json' o ajustar la URL.
    function loadInitialData() {
      fetch('./albionData.json') // Intenta cargar el archivo desde la raíz
        .then(response => {
          if (!response.ok) {
            // Si hay un error, por ejemplo, 404, mostramos un mensaje
            throw new Error(`Error al cargar albionData.json: ${response.statusText}`);
          }
          return response.json();
        })
        .then(parsedData => {
          if (!Array.isArray(parsedData)) {
            throw new Error('El archivo JSON no es un array válido.');
          }
          data = parsedData;
          normalizeData();
          renderResults();
          clearGuildForm();
          console.log('Datos cargados desde albionData.json.');
        })
        .catch(error => {
          console.error('Error durante la carga inicial de datos:', error);
          Swal.fire('Error de Carga', 'No se pudieron obtener los datos de Albion. Verifica la URL del archivo JSON.', 'error');
          // Si falla, al menos inicializamos la tabla vacía y el formulario
          renderResults();
          clearGuildForm();
        });
    }


    // --- busqueda ---
    searchInput.addEventListener('input', (e) => renderResults(e.target.value));

    // --- tema (palanca) ---
    function applyTheme(theme) {
      const light = theme === 'light';
      bodyEl.classList.toggle('light', light);
      themeSwitch.classList.toggle('on', light);
      localStorage.setItem('theme', theme); // Mantenemos el tema en localStorage
    }
    themeSwitch.addEventListener('click', () => {
      const newT = bodyEl.classList.contains('light') ? 'dark' : 'light';
      applyTheme(newT);
    });
    themeSwitch.addEventListener('keydown', (e) => { if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); themeSwitch.click(); }});
    applyTheme(localStorage.getItem('theme') || 'dark');

    // --- inicializacion ---
    loadInitialData(); // ¡Cargamos los datos al inicio!

    // --- util: escape HTML (si necesitaras insertar HTML) ---
    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (m) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
    }
  </script>
</body>
</html>
